<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>USDPEN ‚Ä¢ Bid/Ask promedio vs Spot</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="/socket.io/socket.io.js"></script>

  <style>
    :root {
      --bg:#0f172a; --card:#111827; --text:#e6edf3; --muted:#9fb1c6;
      --grid:#18233d; --pill:#0f1c2e; --pill-b:#1f3b5c;
      --bid:#22c55e; --ask:#ef4444; --spot:#eab308;
    }

    html,body{margin:0;background:var(--bg);color:var(--text);
      font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Helvetica,Arial,sans-serif;
      overflow-x:hidden;
    }
    header{display:flex;justify-content:space-between;align-items:center;
      padding:12px 16px;border-bottom:1px solid #1f2937;background:#0b1222}
    .badge{background:#0f1c2e;border:1px solid #1f3b5c;border-radius:999px;padding:4px 10px;font-size:12px}
    .container{max-width:1100px;margin:0 auto;padding:16px}
    .grid{display:grid;gap:16px;grid-template-columns:1fr}
    .card{background:var(--card);border-radius:12px;padding:14px;box-shadow:0 6px 24px rgba(0,0,0,.25)}
    .stats{display:flex;gap:8px;flex-wrap:wrap;margin-top:8px}
    .pill{display:inline-block;padding:6px 12px;border-radius:999px;background:var(--pill);color:#9fd1ff;border:1px solid var(--pill-b);font-size:13px}
    .legend{display:flex;gap:12px;margin:8px 0 6px;flex-wrap:wrap}
    .dot{width:10px;height:10px;border-radius:50%;display:inline-block;margin-right:6px;}
    .dot-bid{background:var(--bid)} .dot-ask{background:var(--ask)} .dot-spot{background:var(--spot)}
    footer{text-align:center;color:var(--muted);padding:12px;font-size:12px;line-height:1.4}
    label{display:block;margin-top:8px}
    input[type="date"]{padding:6px 10px;border-radius:8px;border:1px solid #213259;background:#0b1222;color:var(--text)}

    /* ====== Responsive (portrait) ====== */
    @media (orientation: portrait) {
      .container{padding:12px}
      .card{padding:12px;border-radius:14px}
      h3{font-size:clamp(16px,4.2vw,20px);margin:0 0 8px}
      header strong{font-size:clamp(16px,4.5vw,20px)}
      .badge{font-size:12px;padding:4px 10px}
      .pill{font-size:13px;padding:6px 10px}
      .legend{gap:10px}
      /* El chart toma altura real de pantalla */
      .chart-wrap{
        height:58vh;              /* ajusta 55‚Äì65 seg√∫n prefieras */
        min-height:320px;
        width:100%;
      }
      .chart-wrap canvas{
        width:100% !important;
        height:100% !important;
        display:block;
      }
    }

    /* Muy angosto */
    @media (max-width: 380px){
      .pill{font-size:12px;padding:5px 8px}
      input[type="date"]{font-size:13px}
    }
  </style>
</head>
<body>
<header>
  <div><strong>USDPEN</strong> ‚Ä¢ Bid/Ask promedio vs Spot (Bloomberg)</div>
  <div style="display:flex; gap:12px; align-items:center;">
    <div class="badge" id="clock">--:--:--</div>
    <div class="badge" id="fintech-count">Fintechs: 0</div>
  </div>
</header>

<div class="container">
  <div class="grid">
    <div class="card">
      <h3>Mejor Compra / Mejor Venta</h3>
      <div class="stats" id="best-trades">
        <span class="pill">Compra: ‚Äî</span>
        <span class="pill">Vende: ‚Äî</span>
      </div>
      <div class="stats" id="arbitrage-alert">
        <span class="pill">Oportunidad: ‚Äî</span>
      </div>
    </div>

    <div class="card">
      <h3>Serie intrad√≠a</h3>
      <div class="legend">
        <span><span class="dot dot-bid"></span>Bid Prom</span>
        <span><span class="dot dot-ask"></span>Ask Prom</span>
        <span><span class="dot dot-spot"></span>Spot</span>
      </div>

      <label for="fechaSelector">Seleccionar fecha:</label>
      <input type="date" id="fechaSelector" />

      <!-- üëá El canvas ahora vive en un wrapper de altura flexible -->
      <div class="chart-wrap">
        <canvas id="chart"></canvas>
      </div>

      <div class="stats" id="stats"></div>
    </div>
  </div>
</div>

<footer>
  Actualiza autom√°tico cada 5 minutos ‚Ä¢ Fuente fintech: cuantoestaeldolar.pe ‚Ä¢ Spot: Bloomberg<br>
  <span style="font-weight:600; color:#e6edf3;">Dashboard elaborado por el √Årea de Riesgo de Mercado y Liquidez - AGROBANCO</span>
</footer>

<script>
const socket = io();
let liveSeries = [];
const labels = [], bidData = [], askData = [], spotData = [];

/* ====== Chart ====== */
const ctx = document.getElementById('chart').getContext('2d');
const chart = new Chart(ctx, {
  type: 'line',
  data: {
    labels,
    datasets:[
      { label:'Bid Prom', data: bidData, borderWidth:2, tension:0.2,
        borderColor:getComputedStyle(document.documentElement).getPropertyValue('--bid').trim(),
        pointBackgroundColor:getComputedStyle(document.documentElement).getPropertyValue('--bid').trim(),
        pointRadius:2, pointHoverRadius:4 },
      { label:'Ask Prom', data: askData, borderWidth:2, tension:0.2,
        borderColor:getComputedStyle(document.documentElement).getPropertyValue('--ask').trim(),
        pointBackgroundColor:getComputedStyle(document.documentElement).getPropertyValue('--ask').trim(),
        pointRadius:2, pointHoverRadius:4 },
      { label:'Spot', data: spotData, borderWidth:2, tension:0.2,
        borderColor:getComputedStyle(document.documentElement).getPropertyValue('--spot').trim(),
        pointBackgroundColor:getComputedStyle(document.documentElement).getPropertyValue('--spot').trim(),
        pointRadius:2, pointHoverRadius:4 }
    ]
  },
  options: {
    responsive:true,
    maintainAspectRatio:false,    // ‚Üê clave para usar la altura del wrapper
    animation:false,
    interaction:{ mode:'nearest', intersect:false },
    plugins:{
      legend:{ labels:{ color:'#cdd6e3', boxWidth:10, usePointStyle:true, pointStyle:'rectRounded' }},
      tooltip:{ enabled:true }
    },
    scales:{
      x:{ ticks:{ color:'#9fb1c6', maxRotation:0, autoSkip:true }, grid:{ color: 'var(--grid)' }},
      y:{ ticks:{ color:'#9fb1c6', callback:v=>Number(v).toFixed(3) }, grid:{ color:'var(--grid)' }}
    }
  }
});

// Resize suave al rotar el tel√©fono
window.addEventListener('orientationchange', () => setTimeout(() => chart.resize(), 250));

/* ====== helpers ====== */
function formatTs(ts){
  const d=new Date(ts);
  const yyyy=d.getFullYear();
  const mm=String(d.getMonth()+1).padStart(2,'0');
  const dd=String(d.getDate()).padStart(2,'0');
  const hh=String(d.getHours()).padStart(2,'0');
  const min=String(d.getMinutes()).padStart(2,'0');
  const ss=String(d.getSeconds()).padStart(2,'0');
  return { ts:`${hh}:${min}:${ss}`, date:`${yyyy}-${mm}-${dd}` };
}

function renderSeries(series){
  labels.length=0; bidData.length=0; askData.length=0; spotData.length=0;
  series.forEach(pt=>{
    const f=formatTs(pt.timestamp||pt.ts);
    labels.push(f.ts);
    bidData.push(pt.bid_avg??null);
    askData.push(pt.ask_avg??null);
    spotData.push(pt.spot??null);
  });
  chart.update();

  const last=series[series.length-1];
  if(last){
    const fmt=v=>(v==null||v==='')?'‚Äî':Number(v).toFixed(4);
    const fLast=formatTs(last.timestamp||last.ts);
    document.getElementById('stats').innerHTML=
      `<span class="pill">√öltima: ${fLast.ts}</span>
       <span class="pill">Bid Prom: <b>${fmt(last.bid_avg)}</b></span>
       <span class="pill">Ask Prom: <b>${fmt(last.ask_avg)}</b></span>
       <span class="pill">Spot: <b>${fmt(last.spot)}</b></span>`;

    if(last.bestBuy && last.bestSell){
      document.getElementById('best-trades').innerHTML=
        `<span class="pill">Compra: <b>${last.bestBuy.name}</b> (${fmt(last.bestBuy.buy)})</span>
         <span class="pill">Venta: <b>${last.bestSell.name}</b> (${fmt(last.bestSell.sell)})</span>`;

      // Arbitraje simple
      const buy = Number(last.bestBuy.buy);
      const sell = Number(last.bestSell.sell);
      const arbitrageDiv = document.getElementById('arbitrage-alert');
      if(Number.isFinite(buy) && Number.isFinite(sell) && sell > buy){
        const profit1000  = ((sell - buy) * 1000).toFixed(2);
        const profit10000 = ((sell - buy) * 10000).toFixed(2);
        arbitrageDiv.innerHTML = `<span class="pill" style="background:var(--bid);color:#00131f;">
          Arbitraje: S√≠ üí∞ +${profit1000} (x1,000 USD) | +${profit10000} (x10,000 USD)
        </span>`;
      } else {
        arbitrageDiv.innerHTML = `<span class="pill">Oportunidad: ‚Äî</span>`;
      }
    }
  }
}

function filterByDate(fecha){
  return liveSeries.filter(pt=>formatTs(pt.timestamp||pt.ts).date===fecha);
}

/* ====== fecha default: hoy ====== */
const fechaSelector=document.getElementById('fechaSelector');
const hoy=new Date();
fechaSelector.value=`${hoy.getFullYear()}-${String(hoy.getMonth()+1).padStart(2,'0')}-${String(hoy.getDate()).padStart(2,'0')}`;
fechaSelector.addEventListener('change',()=>{
  const selectedDate=fechaSelector.value;
  if(!selectedDate) return;
  renderSeries(filterByDate(selectedDate));
});

/* ====== socket ====== */
const fintechBadge = document.getElementById('fintech-count');

socket.on('boot',series=>{
  liveSeries=series||[];
  renderSeries(filterByDate(fechaSelector.value));
  const last = liveSeries[liveSeries.length-1];
  if(last) fintechBadge.textContent = `Fintechs: ${last.sampleCount || 0}`;
});

socket.on('tick', pt => {
  liveSeries.push(pt);
  if(liveSeries.length>2000) liveSeries.shift();
  const today=new Date().toISOString().split('T')[0];
  if(!fechaSelector.value || fechaSelector.value===today){
    renderSeries(filterByDate(today));
  }
  fintechBadge.textContent = `Fintechs: ${pt.sampleCount || 0}`;
});

/* ====== reloj ====== */
setInterval(()=>{
  const d=new Date();
  document.getElementById('clock').textContent=
    d.toLocaleTimeString('es-PE',{hour12:false,timeZone:'America/Lima'});
},1000);
</script>
</body>
</html>

